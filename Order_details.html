<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<script src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/rem.js"></script>
		<link rel="stylesheet" href="css/base.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav base">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">订单详情</h1>
		</header>
		<div class="mui-content">
			<div class="Order_ca">
			</div>
			<div class="botto1" id="bott">
				<!--<div class="bu1" style="margin-left: 0.3rem; ">
					拒单
				</div>-->
				<div class="bu" id="bott">
					接单
				</div>
			</div>
		</div>

	</body>
	<script src="js/jquery-2.1.0.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		$(function() {
			var url_url = localStorage.getItem("register_url");
			//			var  data_id=localStorage.getItem("data_id")
			$.ajax({
				type: "GET",
				url: url_url + "/order/Infor",
				dataType: 'json',
				async: true,
				data: {
					order_id: localStorage.getItem('orderid'),
				},
				success: function(data) {
					$('.Order_ca').append(`
							<div class="Order_span">
								<span>订单编号</span>
								<span style="float: right;">${data.data.pb_order_number}</span>
							</div>
							<div class="Order_span">
								<span>订单类型</span>
								<span style="float: right;">${data.data.pb_skill_type_one_title}-${data.data.pb_skill_type_title}</span>
							</div>
							<div class="Order_span">
								<span>下单时间:</span>
								<span style="float: right;">${data.data.create_time_show}</span>
							</div>
							<div class="Order_span">
								<span>上门时间:</span>
								<span style="float: right;">${data.data.sm_time}</span>
							</div>
							<div class="Order_span">
								<span>联系人:</span>
								<span style="float: right;">${data.data.pb_order_name}</span>
							</div>
							<div class="Order_span">
								<span>下单类型:</span>
								<span style="float: right;">${data.data.pb_order_type==0?'派单':'抢单'}</span>
							</div>
							<div class="Order_span">
								<span style="color: #FF0000;">订单押金:</span>
								<span style="float: right;color: #FF0000;">${data.data.pb_order_deposit}元</span>
							</div>
						</div>
						<div class="details">
							<div class="details_a">
								<a>备注内容:</a>
							</div>
			
							<div class="details_textarea">
								<textarea disabled="disabled" readonly="readonly">${data.data.pb_order_details_note}</textarea>
							</div>
						</div>
						<div class="details">
							<div class="details_a">
								<a>订单照片:</a>
							</div>
							<div class="details_textarea" id='details_textarea'>
							</div>
						</div>
						
					`)
					var myimg = JSON.parse(data.data.pb_order_details_img)
					for(var i = 0; i < myimg.length; i++) {
						$('#details_textarea').append(`
							<img src="${url_url + myimg[i]}"/>
						`)
					}
					if(data.data.pb_order_type == 0) {
						//获取状态值
						//拒绝订单
						$('.bu1').click(function() {
							$.ajax({
								type: "post",
								url: url_url + "/task/assignment_do",
								async: true,
								dataType: "json",
								data: {
									order_number: data.data.pb_order_number,
									send_orders_state: 2
								},
								success: function(data) {
									if(data.status == 1) {
										var order=plus.webview.getWebviewById('Order')
										mui.file(order,'haveOrder',{})
										plus.nativeUI.toast("拒绝成功");
										mui.back()
									}
								},
								error: function(err) {
									plus.nativeUI.toast("拒绝失败");
								}
							});
						})
						//判断是否接单
						$('.bu').click(function() {
							$.ajax({
								type: "post",
								url: url_url + "/task/assignment_do",
								async: true,
								dataType: 'json',
								data: {
									order_number: data.data.pb_order_number,
									send_orders_state: 1
								},
								success: function(data) {
									console.log(JSON.stringify(data))
									if(data.status == 1) {
										var order=plus.webview.getWebviewById('Order')
										mui.fire(order,'haveOrder',{})
										plus.nativeUI.toast("接单成功");
										mui.back()
									} else {
										alert(data.msg)
									}
								},
								error: function(err) {
									plus.nativeUI.toast(err.responseJSON.msg);
								}
							});
						})
					} else {
						//获取状态值
						//拒绝订单
						$('.bu1').hide()
						//判断是否接单
						$('.bu').click(function() {
							$.ajax({
								type: "post",
								url: url_url + "/task/preemption_do",
								async: true,
								dataType: 'json',
								data: {
									order_id: data.data.pb_order_id,
									user_id: localStorage.getItem('data_id')
								},
								success: function(data) {
									if(data.status == 1) {
										var order=plus.webview.getWebviewById('Order')
										mui.fire(order,'haveOrder',{})
										plus.nativeUI.toast("接单成功");
										mui.back()
									} else {
										plus.nativeUI.toast("该订单已被抢啦，下次记得早点来呦~");
									}
								},
								error: function(err) {
									plus.nativeUI.toast(err.responseJSON.msg);
								}
							});
						})
					}
				},
				error: function(data) {
					console.log(JSON.stringify(data));
				}
			});
			$('.Order_ca').on('click','img',function(){
				plus.nativeUI.previewImage([
					$(this).attr('src')
				])
			})
		})
	</script>

</html>